{{#extend "window"}}
{{#content "window"}}
<frame pos="1 -1" id="ecm-window" size="{{ subtract size.x 2 }} {{ subtract size.y 2 }}">
  <frame id="recording-status" size="{{ subtract size.x 2 }} 5">
    <label text="" pos="0 -2.25" textcolor="{{#if config.isRecording}}2D2{{else}}D22{{/if}}" textsize="1" valign="center" />
    <label text="{{#if config.isRecording}}Recording{{else}}Not Recording{{/if}}" pos="3.5 -2.25" size="20 5" textsize="1" textcolor="222" valign="center" textfont="GameFontRegular" />

    <frame id="toggle-recording" pos="25 0" size="25 5">
      <quad pos="0 0" size="25 5" bgcolor="CCC" action="ecm-toggle-recording" />
      <quad pos="0 -4.75" size="25 0.25" bgcolor="222" />
      <label pos="12.5 -2.25" text="{{#if config.isRecording}}Stop{{else}}Start{{/if}} recording" textsize="1" textcolor="222" valign="center" halign="center" textfont="GameFontRegular" />
    </frame>
  </frame>

  <frame id="api-key-frame" pos="0 -6" size="{{ subtract size.x 2 }} 12.25">
    <label text="API Key" pos="0 -2.25" size="25 3" textsize="0.6" textcolor="222" valign="center" textfont="GameFontSemiBold" />
    <frame id="input-frame" pos="0 -4.5" size="{{ subtract size.x 2 }} 7.75">
      <quad pos="0 -4.75" size="35 0.25" bgcolor="222" />
      <entry pos="0 -2.25" default="{{ config.apiKey }}" size="30 5" name="ecm-api-key-entry" id="ecm-api-key-entry" class="ecm-api-key-entry" textsize="1" focusareacolor1="CCC" focusareacolor2="CCC" textcolor="222" scriptevents="1" textformat="Password" valuetype="Ml_String" valign="center" textfont="GameFontRegular" />
      <label pos="32.5 -2.25" size="5 5" text="" textcolor="222" focusareacolor1="CCC" focusareacolor2="CCC" halign="center" valign="center" textsize="1" scriptevents="1" class="ecm-api-key-entry-toggle" />

      <frame id="save-api-key" pos="38 0" size="12 5">
        <quad pos="0 0" size="12 5" bgcolor="CCC" action="ecm-save-api-key" />
        <quad pos="0 -4.75" size="12 0.25" bgcolor="222" />
        <label pos="6 -2.25" text="Save" textsize="1" textcolor="222" valign="center" halign="center" textfont="GameFontRegular" />
      </frame>

      <label id="error-label" pos="0 -6.25" size="{{ subtract size.x 2 }} 3" textsize="0.6" textcolor="D22" valign="center" textfont="GameFontRegular" />
    </frame>
  </frame>
</frame>
{{/content}}

{{#content "globals"}}
#Struct eCMConfig {
  Text apiKey;
  Boolean isRecording;
}
{{/content}}

{{#content "script"}}
Void updateRecording(eCMConfig ecmConfig) {
  declare window <=> (Page.MainFrame.GetFirstChild("ecm-window") as CMlFrame);
  declare statusFrame <=> (window.GetFirstChild("recording-status") as CMlFrame);
  declare toggleRecordingFrame <=> (statusFrame.GetFirstChild("toggle-recording") as CMlFrame);

  declare recordingStatusLabel <=> statusFrame.Controls[0] as CMlLabel;
  declare labelText <=> statusFrame.Controls[1] as CMlLabel;
  declare toggleRecordingLabel <=> toggleRecordingFrame.Controls[2] as CMlLabel;

  declare Real low = 2./16.;
  declare Real high = 14./16.;

  if (ecmConfig.isRecording) {
    recordingStatusLabel.TextColor = <low,high,low>;
    labelText.SetText("Recording");
    toggleRecordingLabel.SetText("Stop recording");
  } else {
    recordingStatusLabel.TextColor = <high,low,low>;
    labelText.SetText("Not Recording");
    toggleRecordingLabel.SetText("Start recording");
  }
}

Void updateApiKey(eCMConfig ecmConfig) {
  declare window <=> (Page.MainFrame.GetFirstChild("ecm-window") as CMlFrame);
  declare apiKeyFrame <=> (window.GetFirstChild("api-key-frame") as CMlFrame);
  declare inputFrame <=> (apiKeyFrame.GetFirstChild("input-frame") as CMlFrame);
  declare apiKeyEntry <=> (inputFrame.GetFirstChild("ecm-api-key-entry") as CMlEntry);

  apiKeyEntry.SetText(ecmConfig.apiKey, False);
}

Void updateWindow(eCMConfig ecmConfig) {
  updateRecording(ecmConfig);
  updateApiKey(ecmConfig);
}
{{/content}}

{{#content "main"}}
declare eCMConfig ECMConfig for This;
declare Integer LastECMConfigUpdate for This = -1;
declare Integer lastUpdate = -1;
{{/content}}

{{#content "loop"}}
if (LastECMConfigUpdate != lastUpdate) {
  lastUpdate = LastECMConfigUpdate;
  updateWindow(ECMConfig);
}
{{/content}}

{{#content "events"}}
if (event.Control.HasClass("ecm-api-key-entry") && event.Type == CMlScriptEvent::Type::EntrySubmit) {
  declare entryControl <=> (event.Control as CMlEntry);
  declare errorLabel <=> (entryControl.Parent.GetFirstChild("error-label") as CMlLabel);

  declare Integer nbUnderscores = TL::Split("_", entryControl.Value, False).count - 1;
  if (nbUnderscores < 0) {
    nbUnderscores = 0;
  }

  if (nbUnderscores != 1) {
    errorLabel.SetText("Expected 1 underscore, found " ^ nbUnderscores);
  } else {
    errorLabel.SetText("");
  }
}

if (event.Control.HasClass("ecm-api-key-entry-toggle") && event.Type == CMlScriptEvent::Type::MouseClick) {
  declare entryControl <=> (event.Control.Parent.GetFirstChild("ecm-api-key-entry") as CMlEntry);
  if (entryControl.TextFormat == CMlEntry::ETextFormat::Password) {
    entryControl.TextFormat = CMlEntry::ETextFormat::Basic;
    (event.Control as CMlLabel).SetText("");
  } else {
    entryControl.TextFormat = CMlEntry::ETextFormat::Password;
    (event.Control as CMlLabel).SetText("");
  }
}
{{/content}}
{{/extend}}